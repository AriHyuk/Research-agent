<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Jurnal Assistant - Sequential Agent</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card-header { background-color: #0d6efd; color: white; font-weight: bold; }
        .loading-overlay { display: none; }
        .stage-box { background: #f1f3f5; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.9em; max-height: 200px; overflow-y: auto; }
        #resultContainer { display: none; /* Sembunyikan dulu sebelum ada hasil */ }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <div class="text-center mb-5">
                <h1>üéì AI Jurnal Assistant</h1>
                <p class="lead text-muted">Powered by Google Vertex AI (Sequential Agent + Grounding)</p>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    üöÄ Mulai Riset Baru
                </div>
                <div class="card-body p-4">
                    <form id="researchForm">
                        <div class="mb-3">
                            <label for="inputTopik" class="form-label fw-bold">Topik Jurnal / Judul Skripsi:</label>
                            <textarea class="form-control" id="inputTopik" rows="3" placeholder="Contoh: Analisis dampak AI terhadap efisiensi UMKM kuliner di Jakarta..." required></textarea>
                        </div>
                        <div class="mb-3">
                             <label for="inputTarget" class="form-label fw-bold">Target Pembaca:</label>
                             <select class="form-select" id="inputTarget">
                                 <option value="Dosen Penguji Skripsi" selected>Dosen Penguji Skripsi (Sangat Akademis)</option>
                                 <option value="Mahasiswa Semester Awal">Mahasiswa Semester Awal (Mudah Dipahami)</option>
                                 <option value="Investor Bisnis">Investor Bisnis (Fokus pada Data & Profit)</option>
                             </select>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="btnSubmit">
                                üîç Jalankan Agen Riset (Sequential)
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="loadingSpinner" class="text-center my-5 loading-overlay">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                <p class="mt-3 fw-bold text-primary">Sedang bekerja... (Googling -> Nulis -> Review)</p>
                <small class="text-muted">Proses ini butuh waktu 10-30 detik karena agen bekerja estafet.</small>
            </div>

            <div id="errorAlert" class="alert alert-danger alert-dismissible fade show" style="display: none;" role="alert">
                <strong>Terjadi Kesalahan!</strong> <span id="errorMessage"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <div id="resultContainer" class="card shadow-lg border-success">
                <div class="card-header bg-success text-white">
                    ‚úÖ Hasil Akhir Jurnal (Final Draft)
                </div>
                <div class="card-body p-4">
                    <div class="mb-4">
                         <h4 class="card-title">Naskah Akademik:</h4>
                         <div id="finalOutputText" style="white-space: pre-wrap;"></div>
                    </div>

                    <div class="alert alert-info">
                        <strong>üîó Validasi Sumber (Grounding):</strong>
                        <ul id="sourceList" class="mb-0 ps-3">
                            </ul>
                    </div>
                    
                    <hr class="my-4">

                    <h5 class="text-muted mb-3">üïµÔ∏è‚Äç‚ôÇÔ∏è Dibalik Layar (Proses Sequential Agent)</h5>
                    <div class="accordion" id="accordionStages">
                        <div class="accordion-item">
                          <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                              Tahap 1: Researcher Agent (Data Mentah Google)
                            </button>
                          </h2>
                          <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionStages">
                            <div class="accordion-body">
                                <div class="stage-box" id="stage1Output"></div>
                            </div>
                          </div>
                        </div>
                        <div class="accordion-item">
                          <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                              Tahap 2: Writer Agent (Draft Kasar)
                            </button>
                          </h2>
                          <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#accordionStages">
                            <div class="accordion-body">
                                <div class="stage-box" id="stage2Output"></div>
                            </div>
                          </div>
                        </div>
                      </div>
                      </div>
            </div> </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const form = document.getElementById('researchForm');
    const btnSubmit = document.getElementById('btnSubmit');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultContainer = document.getElementById('resultContainer');
    const errorAlert = document.getElementById('errorAlert');

    // URL API CLOUD RUN KAMU (Endpoint Sequential)
    const API_URL = "https://research-api-605141282095.us-central1.run.app/api/riset-lengkap";

    form.addEventListener('submit', async (e) => {
        e.preventDefault(); // Mencegah halaman reload

        // 1. Ambil data input
        const topik = document.getElementById('inputTopik').value;
        const target = document.getElementById('inputTarget').value;

        // 2. Reset Tampilan (Munculin loading, sembunyiin hasil lama)
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = "‚è≥ Sedang Memproses...";
        loadingSpinner.style.display = 'block';
        resultContainer.style.display = 'none';
        errorAlert.style.display = 'none';

        try {
            console.log("Mengirim request ke API...");
            // 3. TEMBAK API (Fetch)
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    topik: topik,
                    target_pembaca: target
                })
            });

            const data = await response.json();
            console.log("Respon diterima:", data);

            if (!response.ok) {
                throw new Error(data.detail || 'Terjadi kesalahan pada server.');
            }

            // 4. TAMPILKAN HASIL SUKSES
            // Isi Hasil Final
            document.getElementById('finalOutputText').innerText = data.hasil_final;
            
            // Isi Sumber
            const sourceList = document.getElementById('sourceList');
            sourceList.innerHTML = ''; // Kosongkan dulu
            if (data.sumber && data.sumber.length > 0) {
                data.sumber.forEach(src => {
                    sourceList.innerHTML += `<li>‚úÖ ${src}</li>`;
                });
            } else {
                sourceList.innerHTML = `<li>‚ö†Ô∏è Tidak ada metadata sumber spesifik (General Knowledge).</li>`;
            }

            // Isi Tahapan (Dibalik Layar)
            document.getElementById('stage1Output').innerText = data.tahapan["1_riset_raw"];
            document.getElementById('stage2Output').innerText = data.tahapan["2_draft_awal"];

            // Munculkan card hasil
            resultContainer.style.display = 'block';
            // Scroll ke hasil
            resultContainer.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            console.error("Error:", error);
            // Tampilkan pesan error
            document.getElementById('errorMessage').innerText = error.message;
            errorAlert.style.display = 'block';
        } finally {
            // 5. Balikin tombol & loading ke semula
            btnSubmit.disabled = false;
            btnSubmit.innerHTML = "üîç Jalankan Agen Riset (Sequential)";
            loadingSpinner.style.display = 'none';
        }
    });
</script>

</body>
</html>